# 工作日志桌面应用 - 最新项目设计文档

## 1. 项目概述

- 目标：以模板驱动的方式高效生成工作日志，日志以纯文本内容持久化并与模板解耦，支持分类层级、状态跟踪与 Excel 文件存储。
- 平台：`.NET Framework 4.7.2`，UI 为 WinForms，兼容 Windows 7/10；Excel 读写使用 NPOI。
- 存储：按月写入单个 `.xlsx` 文件，单 Sheet（名称：`工作日志`），以“中文表头 + 按天分块 + 总结行”的结构组织。

## 2. 分层架构

```text
WorkLogApp/
├── WorkLogApp.UI/                 # 表示层（WinForms）
│   ├── Forms/                     # 主界面与各功能窗体
│   │   ├── MainForm.cs            # 主界面：列表、排序、每日总结、保存/打开位置
│   │   ├── ItemCreateForm.cs      # 模板驱动创建窗口
│   │   ├── ItemEditForm.cs        # 纯文本编辑窗口
│   │   ├── CategoryManageForm.cs  # 分类与模板管理
│   │   └── ImportWizardForm.cs    # 导入向导
│   ├── Controls/                  # 自定义控件
│   │   ├── CategoryTreeComboBox.cs
│   │   └── DynamicFormPanel.cs    # 动态生成模板表单
│   └── UI/UIStyleManager.cs       # 统一界面风格与增强
│
├── WorkLogApp.Core/               # 领域层（模型、枚举、工具）
│   ├── Models/                    # `WorkLog`, `WorkLogItem`, `Category` 等
│   ├── Enums/                     # `StatusEnum` 等
│   └── Utils/                     # 通用工具
│
├── WorkLogApp.Services/           # 业务层（接口与实现）
│   ├── Interfaces/                # `ITemplateService`, `IImportExportService` 等
│   └── Implementations/           # `TemplateService`, `ImportExportService` 等
│
└── Templates/                     # 模板配置（JSON）
    └── templates.json
```

## 3. 关键模块与职责

- `MainForm`：
  - 双击编辑并重写当月 Excel：`WorkLogApp.UI/Forms/MainForm.cs:259`, `:283–287`
  - 打开数据文件所在位置：`WorkLogApp.UI/Forms/MainForm.cs:414`
  - 每日总结入口与应用：`WorkLogApp.UI/Forms/MainForm.cs:296`, `:302–314`
  - 列表拖拽排序（ItemDrag/DragEnter/DragOver/DragDrop）：`WorkLogApp.UI/Forms/MainForm.cs:329`, `:337`, `:349`, `:357`
- `ItemCreateForm`：模板驱动创建，动态表单控件生成与提交保存。
- `ItemEditForm`：对渲染后的纯文本进行直接编辑与保存。
- `CategoryManageForm`：
  - 新增分类：`WorkLogApp.UI/Forms/CategoryManageForm.cs:136`
  - 新增子分类（复制父模板结构与选项）：`WorkLogApp.UI/Forms/CategoryManageForm.cs:152–200`
  - 占位符插入列表刷新：`WorkLogApp.UI/Forms/CategoryManageForm.cs:202–216`
- `ImportWizardForm`：
  - 预览与批量导入（按月分组写入）：`WorkLogApp.UI/Forms/ImportWizardForm.cs:86–119`
- `UIStyleManager`：统一字体、缩放与主题，初始化与增强：`WorkLogApp.UI/Program.cs:17–19`, `:58–60`

## 4. 模板系统设计

- 模板加载与保存：
  - 应用启动时加载 `Templates/templates.json`：`WorkLogApp.UI/Program.cs:53–57`
  - 业务接口：`WorkLogApp.Services/Interfaces/ITemplateService.cs:1–17`
  - 实现：
    - 加载：`WorkLogApp.Services/Implementations/TemplateService.cs:16`
    - 保存：`WorkLogApp.Services/Implementations/TemplateService.cs:26`
    - 新增/更新分类模板：`WorkLogApp.Services/Implementations/TemplateService.cs:179`
    - 删除分类模板：`WorkLogApp.Services/Implementations/TemplateService.cs:187`
- 渲染与占位符：
  - 渲染方法：支持 `{字段}` 与 `{字段:格式}`，日期格式优先，回退 `ToString`：`WorkLogApp.Services/Implementations/TemplateService.cs:45–81`
  - 系统字段示例：`{ItemTitle}`, `{CategoryPath}` 注入：`WorkLogApp.Services/Implementations/TemplateService.cs:75–80`
- 分类层级合并：
  - 将 `父-子-孙` 名称链中的模板格式、占位符与选项合并，格式文本以空行分隔拼接：`WorkLogApp.Services/Implementations/TemplateService.cs:93–160`

## 5. Excel 导入导出规范

- 存储结构：单 Sheet `工作日志`，中文表头：`日期/标题/内容/分类ID/开始时间/结束时间/标签/排序`（列样式含块底色与加粗标题）。
- 导出合并策略：对同月数据合并现有与新增，按天聚合后覆盖写入：`WorkLogApp.Services/Implementations/ImportExportService.cs:40–64`, `:67–85`
- 写入细节：
  - 日期块标识行：`===== yyyy年MM月dd日 星期X =====` 合并整行：`WorkLogApp.Services/Implementations/ImportExportService.cs:219–230`
  - 事项排序：`SortOrder` → `StartTime` → `ItemTitle`：`WorkLogApp.Services/Implementations/ImportExportService.cs:231–235`
  - 当日总结行（标题=当日总结，内容=总结文本）：`WorkLogApp.Services/Implementations/ImportExportService.cs:265–277`
  - 列宽与样式设置：`WorkLogApp.Services/Implementations/ImportExportService.cs:280–288`
- 分类ID写入策略：优先写模板名称，失败回退为数值ID；名称到稳定ID映射通过 FNV-1a：`WorkLogApp.Services/Implementations/ImportExportService.cs:90–107`, `:246–255`, `:566–582`
- 导入：
  - 从目录按月读取：`WorkLogApp.Services/Implementations/ImportExportService.cs:305–399`
  - 从文件读取：`WorkLogApp.Services/Implementations/ImportExportService.cs:401–491`
  - 识别日期块与“当日总结”行，并归位到对应 `WorkLog.LogDate`：`WorkLogApp.Services/Implementations/ImportExportService.cs:324–340`, `:343–356`

## 6. UI 交互流程

- 月/日视图切换与控件显隐：`WorkLogApp.UI/Forms/MainForm.cs:251–257`
- 双击编辑后重写当月 Excel 并刷新列表：`WorkLogApp.UI/Forms/MainForm.cs:259`, `:283–287`
- 每日总结生成：从当日标题拼接作为初始值，确认后保存并触发写入：`WorkLogApp.UI/Forms/MainForm.cs:302–314`
- 打开当月文件所在位置或目录：`WorkLogApp.UI/Forms/MainForm.cs:414–449`
- 拖拽排序处理：`WorkLogApp.UI/Forms/MainForm.cs:329–369`

## 7. 数据模型

- `WorkLog`：
  - 字段：`LogDate`、`DailySummary`、`Items`
  - 定义：`WorkLogApp.Core/Models/WorkLog.cs:6–11`
- `WorkLogItem`：
  - 字段：`LogDate`、`ItemTitle`、`ItemContent`、`CategoryId`、`Status`、`StartTime`、`EndTime`、`Tags`、`SortOrder`
  - 定义：`WorkLogApp.Core/Models/WorkLogItem.cs:6–17`
- `StatusEnum`：`Todo/Doing/Done/Blocked/Cancelled`：`WorkLogApp.Core/Enums/StatusEnum.cs:3–10`

## 8. 错误处理与日志

- 全局异常捕获：UI 线程与未处理异常均写入 `Logs` 目录并弹窗提示：`WorkLogApp.UI/Program.cs:20–46`
- 各窗体关键操作中捕获异常并以 `MessageBox` 显示错误原因（如导入失败、打开位置失败、编辑窗口失败）。

## 9. 配置与目录结构

- 启动配置与模板路径：`WorkLogApp.UI/Program.cs:50–57`
- `WorkLogApp.UI.csproj` 将 `Configs/dev.config.json`、`Configs/prod.config.json` 与 `Templates/templates.json` 复制到输出目录：`WorkLogApp.UI/WorkLogApp.UI.csproj`
- 数据目录：`AppDomain.CurrentDomain.BaseDirectory/Data`，按月文件命名：`worklog_yyyyMM.xlsx`

## 10. 代码索引（快捷定位）

- 模板服务接口：`WorkLogApp.Services/Interfaces/ITemplateService.cs:1–17`
- 模板服务实现：`WorkLogApp.Services/Implementations/TemplateService.cs:16`, `:26`, `:45`, `:93`, `:179`, `:187`
- 导入导出接口：`WorkLogApp.Services/Interfaces/IImportExportService.cs:7–13`
- 导入导出实现：`WorkLogApp.Services/Implementations/ImportExportService.cs:40`, `:67`, `:86`, `:305`, `:401`, `:566`
- 主界面交互：`WorkLogApp.UI/Forms/MainForm.cs:251`, `:259`, `:283`, `:296`, `:329`, `:337`, `:349`, `:357`, `:414`
- 分类管理：`WorkLogApp.UI/Forms/CategoryManageForm.cs:136`, `:152`, `:202`
- 导入向导：`WorkLogApp.UI/Forms/ImportWizardForm.cs:86`
