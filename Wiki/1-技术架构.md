# 1. 技术架构

## 1.1 架构概览

本项目采用经典的三层分层架构 (3-Tier Architecture)，确保各模块职责单一，易于维护和扩展。

```mermaid
graph TD
    UI[WorkLogApp.UI<br/>(Windows Forms)] --> Services[WorkLogApp.Services<br/>(Business Logic)]
    Services --> Core[WorkLogApp.Core<br/>(Domain Models)]
    UI --> Core
    Services --> NPOI[NPOI<br/>(Excel Handling)]
    Services --> JSON[System.Web.Extensions<br/>(JSON Parsing)]
```

### 分层职责
- **UI 层 (Presentation)**: 负责用户交互、表单展示、数据绑定。处理所有界面逻辑，不包含复杂业务规则。
- **服务层 (Business Logic)**: 负责核心业务逻辑，包括模板渲染、数据导入导出、Excel 文件读写。
- **核心层 (Domain)**: 定义领域模型（Entities）、枚举（Enums）、接口（Interfaces）及基础辅助类。

## 1.2 核心模块

### 1.2.1 UI 模块 (`WorkLogApp.UI`)
- **MainForm**: 主界面，集成日/月视图、列表展示、拖拽排序功能。
- **ItemCreateForm**: 动态表单构建器，根据模板配置自动生成输入控件。
- **CategoryManageForm**: 分类树管理，支持模板继承与编辑。
- **UIStyleManager**: 统一负责高 DPI 适配、字体管理与控件美化。

### 1.2.2 服务模块 (`WorkLogApp.Services`)
- **TemplateService**: 实现 `ITemplateService`，负责模板的加载、解析、层级合并与文本渲染。
- **ImportExportService**: 实现 `IImportExportService`，封装 NPOI 操作，处理 Excel 的复杂格式（合并单元格、样式应用）。

### 1.2.3 核心模块 (`WorkLogApp.Core`)
- **Models**: `WorkLog` (聚合根), `WorkLogItem` (实体), `TemplateRoot` (配置模型)。
- **Enums**: `StatusEnum` (待办/进行中/完成/阻塞/取消)。

## 1.3 数据流向

### 日志创建流程
1. **用户** 在 UI 选择分类。
2. **UI** 调用 `TemplateService` 获取合并后的模板配置。
3. **UI** 根据配置动态生成表单。
4. **用户** 填写表单并提交。
5. **UI** 调用 `TemplateService` 渲染最终文本。
6. **UI** 将数据组装为 `WorkLogItem` 并保存。
7. **Service** 将数据写入当月 Excel 文件。

### 数据加载流程
1. **UI** 请求加载某月数据。
2. **Service** 读取对应 `worklog_yyyyMM.xlsx`。
3. **Service** 解析 Excel 行，识别日期块与特殊行。
4. **Service** 返回 `List<WorkLog>` 给 UI。
5. **UI** 绑定数据到 `ListView`。
