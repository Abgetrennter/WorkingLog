# 3. 服务层（WorkLogApp.Services）

## 接口设计

- `ITemplateService`：模板加载/保存、渲染、获取与层级合并、增删改。参考：`WorkLogApp.Services/Interfaces/ITemplateService.cs:1–17`
- `IImportExportService`：导出整月、重写整月、按月导入、从文件导入。参考：`WorkLogApp.Services/Interfaces/IImportExportService.cs:1–14`

## 模板服务实现（TemplateService）

加载/保存模板：`WorkLogApp.Services/Implementations/TemplateService.cs:16–24`, `:26–43`

```csharp
public bool LoadTemplates(string templatesJsonPath)
{
    var json = File.ReadAllText(templatesJsonPath);
    var serializer = new JavaScriptSerializer();
    _templateRoot = serializer.Deserialize<TemplateRoot>(json);
    _templatesPath = templatesJsonPath;
    return _templateRoot?.Templates != null;
}

public bool SaveTemplates()
{
    var serializer = new JavaScriptSerializer();
    var json = serializer.Serialize(_templateRoot);
    File.WriteAllText(_templatesPath, json);
    return true;
}
```

占位符渲染：`WorkLogApp.Services/Implementations/TemplateService.cs:45–81`

```csharp
public string Render(string formatTemplate, Dictionary<string, object> fieldValues, WorkLogItem item)
{
    var result = formatTemplate ?? string.Empty;
    result = Regex.Replace(result, "\\{([^:{}]+)(?::([^{}]+))?\\}", match =>
    {
        var name = match.Groups[1].Value; var format = match.Groups[2].Success ? match.Groups[2].Value : null;
        object value = fieldValues.ContainsKey(name) ? fieldValues[name] : null;
        if (value == null) return string.Empty;
        if (format != null)
        {
            if (value is DateTime dt) return dt.ToString(format);
            if (value is string s && DateTime.TryParse(s, out var parsed)) return parsed.ToString(format);
            return Convert.ToString(value);
        }
        return Convert.ToString(value);
    });
    result = result.Replace("{ItemTitle}", item?.ItemTitle ?? string.Empty);
    var catPath = fieldValues != null && fieldValues.TryGetValue("CategoryPath", out var cp) ? Convert.ToString(cp) ?? string.Empty : string.Empty;
    result = result.Replace("{CategoryPath}", catPath);
    return result;
}
```

层级模板合并：`WorkLogApp.Services/Implementations/TemplateService.cs:93–160`

```csharp
public CategoryTemplate GetMergedCategoryTemplate(string categoryName)
{
    var parts = categoryName.Split(new[] { '-' }, StringSplitOptions.RemoveEmptyEntries);
    var keys = new List<string>(); for (int i = 0; i < parts.Length; i++) keys.Add(string.Join("-", parts, 0, i + 1));
    CategoryTemplate merged = null;
    foreach (var key in keys)
    {
        if (_templateRoot.Templates.TryGetValue(key, out var cat) && cat?.CategoryTemplate != null)
        {
            var tpl = cat.CategoryTemplate;
            if (merged == null)
            {
                merged = new CategoryTemplate { FormatTemplate = tpl.FormatTemplate ?? string.Empty, Placeholders = new Dictionary<string, string>(tpl.Placeholders, StringComparer.OrdinalIgnoreCase), Options = tpl.Options != null ? CloneOptions(tpl.Options) : new Dictionary<string, List<string>>(StringComparer.OrdinalIgnoreCase) };
            }
            else
            {
                var fmt = tpl.FormatTemplate; if (!string.IsNullOrWhiteSpace(fmt)) merged.FormatTemplate = string.IsNullOrEmpty(merged.FormatTemplate) ? fmt : merged.FormatTemplate + Environment.NewLine + Environment.NewLine + fmt;
                if (tpl.Placeholders != null) foreach (var kv in tpl.Placeholders) merged.Placeholders[kv.Key] = kv.Value;
                if (tpl.Options != null) foreach (var kv in tpl.Options) { if (!merged.Options.TryGetValue(kv.Key, out var list)) merged.Options[kv.Key] = new List<string>(kv.Value ?? new List<string>()); else { var set = new HashSet<string>(list); foreach (var opt in kv.Value ?? new List<string>()) if (set.Add(opt)) list.Add(opt); } }
            }
        }
    }
    return merged;
}
```

## 导入导出实现（ImportExportService）

导出与重写当月：`WorkLogApp.Services/Implementations/ImportExportService.cs:40–64`, `:66–84`

```csharp
public bool ExportMonth(DateTime month, IEnumerable<WorkLog> days, string outputDirectory)
{
    var existingDays = ImportMonth(month, outputDirectory) ?? Enumerable.Empty<WorkLog>();
    var newDays = days.Where(d => d != null && d.LogDate.Year == month.Year && d.LogDate.Month == month.Month);
    var combined = existingDays.Concat(newDays).GroupBy(d => d.LogDate.Date).Select(g => new WorkLog { LogDate = g.Key, DailySummary = g.Select(x => x.DailySummary).FirstOrDefault(s => !string.IsNullOrWhiteSpace(s)) ?? string.Empty, Items = g.SelectMany(x => x.Items ?? new List<WorkLogItem>()).ToList() }).ToList();
    return RewriteMonth(month, combined, outputDirectory);
}
```

日期块与样式写入：`WorkLogApp.Services/Implementations/ImportExportService.cs:219–230`, `:231–277`, `:280–289`

```csharp
var markerRow = sheet.CreateRow(rowIndex);
for (int c = 0; c < HeaderZh.Length; c++)
{
    var cell = markerRow.CreateCell(c);
    cell.CellStyle = markerStyle;
    var week = GetChineseWeekday(day.LogDate.Date);
    cell.SetCellValue(c == 0 ? $"===== {day.LogDate:yyyy年MM月dd日} {week} =====" : string.Empty);
}
sheet.AddMergedRegion(new CellRangeAddress(rowIndex, rowIndex, 0, HeaderZh.Length - 1));
```

导入识别日期块与总结行：`WorkLogApp.Services/Implementations/ImportExportService.cs:324–356`, `:428–456`

```csharp
var firstCellText = GetString(row, 0);
if (!string.IsNullOrWhiteSpace(firstCellText) && firstCellText.StartsWith("====="))
{
    var m = Regex.Match(firstCellText, "=+\\s*(\\d{4}年\\d{2}月\\d{2}日)(?:\\s+星期[一二三四五六日天])?\\s*=+");
    if (m.Success && DateTime.TryParseExact(m.Groups[1].Value, "yyyy年MM月dd日", CultureInfo.InvariantCulture, DateTimeStyles.None, out var dt))
    {
        currentDate = dt.Date;
    }
}
```

稳定 ID 算法（FNV-1a 32-bit）：`WorkLogApp.Services/Implementations/ImportExportService.cs:566–582`

```csharp
private static int StableIdFromName(string name)
{
    unchecked { const uint fnvOffset = 2166136261; const uint fnvPrime = 16777619; uint hash = fnvOffset; foreach (var ch in name) { hash ^= ch; hash *= fnvPrime; } return (int)(hash & 0x7FFFFFFF); }
}
```

## 包与依赖

- `NPOI 2.6.1` 用于 Excel 读写。参考：`WorkLogApp.Services/WorkLogApp.Services.csproj:9`
- `System.Web.Extensions` 用于 `JavaScriptSerializer` 解析模板 JSON。参考：`WorkLogApp.Services/WorkLogApp.Services.csproj:12`

