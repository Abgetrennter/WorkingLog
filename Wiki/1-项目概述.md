# 1. 项目概述

- 目标与平台：通过模板驱动高效生成工作日志，日志以纯文本持久化，支持分类层级、状态跟踪，并按月写入单一 Excel 文件（Sheet 名称 `工作日志`）。参考：`工作日志桌面应用 - 完整项目设计文档.md:5–8`
- 分层架构：UI（WinForms）/ Services（业务逻辑）/ Core（领域模型）/ Templates（JSON 配置）。参考：`工作日志桌面应用 - 完整项目设计文档.md:11–36`

## 关键模块与职责

- `MainForm`：双击编辑并重写当月 Excel；打开数据文件位置；每日总结入口；拖拽排序。参考：`工作日志桌面应用 - 完整项目设计文档.md:40–54`
- `ItemCreateForm`：模板驱动创建，动态表单生成与提交保存（先渲染文本再进入编辑）。
- `ItemEditForm`：直接编辑纯文本并保存到 Excel 与文本备份。
- `CategoryManageForm`：新增分类、复制父模板生成子分类、占位符插入列表刷新。
- `ImportWizardForm`：预览与批量导入（按月分组写入）。
- `UIStyleManager`：统一字体、缩放、主题与抗锯齿。参考：`WorkLogApp.UI/Program.cs:17–19`, `:58–60`

## 模板系统

- 启动加载 `Templates/templates.json`，暴露 `ITemplateService` 接口用于读取/保存/渲染与层级合并。参考：`工作日志桌面应用 - 完整项目设计文档.md:57–70`
- 渲染支持 `{字段}` 与 `{字段:格式}`，日期格式优先，其他类型回退 `ToString`；内置 `{ItemTitle}` 与 `{CategoryPath}`。参考：`WorkLogApp.Services/Implementations/TemplateService.cs:45–81`
- 分类层级合并：`父-子-孙` 名称链依次合并格式文本（以空行分隔拼接）、占位符与选项。参考：`WorkLogApp.Services/Implementations/TemplateService.cs:93–160`

## Excel 导入与导出

- 存储结构：单 Sheet `工作日志`，中文表头：`日期/标题/内容/分类ID/开始时间/结束时间/标签/排序`。参考：`工作日志桌面应用 - 完整项目设计文档.md:73`
- 导出合并策略：同月合并现有与新增，按天聚合后覆盖写入。参考：`WorkLogApp.Services/Implementations/ImportExportService.cs:40–64`, `:67–85`
- 写入细节：
  - 日期块标识行：`===== yyyy年MM月dd日 星期X =====` 并合并整行。参考：`WorkLogApp.Services/Implementations/ImportExportService.cs:219–230`
  - 事项排序：`SortOrder` → `StartTime` → `ItemTitle`。参考：`WorkLogApp.Services/Implementations/ImportExportService.cs:231–235`
  - 当日总结行：标题固定为“当日总结”，内容写入总结文本。参考：`WorkLogApp.Services/Implementations/ImportExportService.cs:265–277`
  - 栏宽与样式：内容列加宽、数字列居中、时间列右对齐。参考：`WorkLogApp.Services/Implementations/ImportExportService.cs:280–288`
- 分类 ID 写入策略：优先写模板名称，失败回退数值 ID；名称到稳定 ID 映射采用 FNV-1a。参考：`WorkLogApp.Services/Implementations/ImportExportService.cs:90–107`, `:566–582`
- 导入：支持从目录按月读取与直接从文件读取，识别日期块与“当日总结”行，并归位到对应 `WorkLog.LogDate`。参考：`工作日志桌面应用 - 完整项目设计文档.md:81–85`

## UI 交互流程

- 月/日视图切换与控件显隐。参考：`WorkLogApp.UI/Forms/MainForm.cs:251–257`
- 双击编辑后重写当月 Excel 并刷新列表。参考：`WorkLogApp.UI/Forms/MainForm.cs:259`, `:283–287`
- 每日总结生成：以当日标题拼接作为初始值，确认后保存并触发写入。参考：`WorkLogApp.UI/Forms/MainForm.cs:302–314`
- 打开当月文件所在位置或目录。参考：`WorkLogApp.UI/Forms/MainForm.cs:414–449`
- 拖拽排序处理。参考：`WorkLogApp.UI/Forms/MainForm.cs:329–369`

## 领域模型

- `WorkLog`：`LogDate`、`DailySummary`、`Items`。参考：`WorkLogApp.Core/Models/WorkLog.cs:6–11`
- `WorkLogItem`：`LogDate`、`ItemTitle`、`ItemContent`、`CategoryId`、`Status`、`StartTime`、`EndTime`、`Tags`、`SortOrder`。参考：`WorkLogApp.Core/Models/WorkLogItem.cs:6–17`
- `StatusEnum`：`Todo/Doing/Done/Blocked/Cancelled`。参考：`WorkLogApp.Core/Enums/StatusEnum.cs:3–10`

## 错误处理与配置

- 全局异常捕获：UI 线程与未处理异常均写入 `Logs` 目录并弹窗提示。参考：`WorkLogApp.UI/Program.cs:20–46`
- 各窗体关键操作中以 `MessageBox` 提示错误原因（导入失败、打开位置失败、编辑失败等）。
- 启动配置与模板路径读取，`Configs/dev.config.json`、`Configs/prod.config.json` 与 `Templates/templates.json` 通过项目文件复制到输出目录。参考：`WorkLogApp.UI/Program.cs:50–57`, `WorkLogApp.UI/WorkLogApp.UI.csproj:84–96`

