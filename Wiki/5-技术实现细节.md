# 5. 技术实现细节

## 层间调用关系与依赖管理

- `WorkLogApp.UI` 引用 `WorkLogApp.Services` 与 `WorkLogApp.Core`。参考：`WorkLogApp.UI/WorkLogApp.UI.csproj:99–106`
- `WorkLogApp.Services` 引用 `WorkLogApp.Core` 并依赖 `NPOI` 与 `System.Web.Extensions`。参考：`WorkLogApp.Services/WorkLogApp.Services.csproj:9–16`
- 启动加载配置与模板路径，注入 `TemplateService` 至 UI。参考：`WorkLogApp.UI/Program.cs:45–61`
- UI 事件通过接口调用服务层：
  - 导出/重写当月：`ImportExportService.ExportMonth`、`RewriteMonth`
  - 模板合并/渲染：`TemplateService.GetMergedCategoryTemplate`、`Render`

## 关键算法与设计模式

- 占位符渲染（Regex）：支持 `{字段}` 与 `{字段:格式}`，日期优先，其他类型回退 `ToString`；系统字段 `{ItemTitle}` 与 `{CategoryPath}`。参考：`WorkLogApp.Services/Implementations/TemplateService.cs:45–81`
- 分类层级合并：按 `父-子-孙` 依次合并格式、占位符与选项，格式以空行分隔拼接。参考：`WorkLogApp.Services/Implementations/TemplateService.cs:93–160`
- 稳定 ID 映射（FNV-1a）：将模板名称映射为稳定正整数，用于 Excel 分类列写入与导入回读。参考：`WorkLogApp.Services/Implementations/ImportExportService.cs:566–582`
- UI 主题与样式策略：
  - DPI 自适应与字体统一；控件树递归应用主题与抗锯齿；富文本设置 1.5 倍行距。参考：`WorkLogApp.UI/UI/UIStyleManager.cs:69–81`, `:88–161`, `:342–381`
  - 设计期检测避免资源依赖，提高设计器预览体验。参考：`WorkLogApp.UI/UI/UIStyleManager.cs:29–43`

## 数据持久化方案

- Excel 文件按月命名 `worklog_yyyyMM.xlsx`，单 Sheet `工作日志`。中文表头与样式规则：日期块标识行加粗并合并整行；内容列加宽；数字列居中；时间列右对齐。参考：`WorkLogApp.Services/Implementations/ImportExportService.cs:117–178`, `:179–201`, `:219–230`, `:280–289`
- 导出合并策略：将现有文件与新增数据按天聚合后覆盖写入，保持当月文件一致性。参考：`WorkLogApp.Services/Implementations/ImportExportService.cs:40–64`
- 导入识别：通过日期块标识与“当日总结”标题识别结构，归位到 `WorkLog.LogDate`。参考：`WorkLogApp.Services/Implementations/ImportExportService.cs:324–356`, `:343–356`, `:428–492`
- 文本备份：编辑保存时同步写入 `Data/yyyy-MM-dd_标题.txt`，便于快速查看与检索。参考：`WorkLogApp.UI/Forms/ItemEditForm.cs:121–129`, `:157–164`

## 架构与打包

- UI 项目复制 `Configs/*.json` 与 `Templates/templates.json` 至输出目录；发布时打包 `dist`。参考：`WorkLogApp.UI/WorkLogApp.UI.csproj:84–96`, `:124–147`
- 解决混合项目引用输出复制问题：在 UI 项目中显式复制 Services 项目的输出 DLL 与 PDB。参考：`WorkLogApp.UI/WorkLogApp.UI.csproj:108–123`

## 错误处理策略

- 全局异常捕获并写入 `Logs`，同时弹窗提示。参考：`WorkLogApp.UI/Program.cs:14–46`
- 窗体层操作围绕 `try/catch` 包裹，统一 `MessageBox` 提示用户。

## 运行机制总览（数据流）

```text
用户创建事项 → 选择分类 → 动态表单填数据
→ 模板渲染生成纯文本 → 打开编辑窗体微调
→ 保存：写入 Excel（按月文件，按天块）与文本备份
→ 主界面：双击编辑、拖拽排序、每日总结 → 重写当月 Excel
→ 导入向导：预览 → 按月分组导入 → 合并写入
```

